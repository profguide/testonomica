# Сервер

    symfony server:start

# Тест

    make tests
    Скрипт очищает базу, выполняет миграции, создаёт фикстуры

## Применение фикстур

    symfony console doctrine:fixtures:load
    APP_ENV=test symfony console doctrine:fixtures:load 

# Миграция

## Создание файлов миграции из моделей

    php bin/console doctrine:migrations:diff

## Применение миграции

    php bin/console doctrine:migrations:migrate
    APP_ENV=test php bin/console doctrine:migrations:migrate

## Откат миграций

    php bin/console doctrine:migrations:migrate prev
    APP_ENV=test php bin/console doctrine:migrations:migrate prev

# TODO

- Версионирование теста. Так, чтобы сохраненный результат не конфликтовал с версией xml теста или калькулятора Возможно,
  нужно указывать в результате версию пройденного теста, а в калькуляторе делать как минимум проверку и юзер-френдли
  исключения а-ля "Конфликт версий", или даже указывать диапазон допустимых версий или даже написать полифил.

# PHPSTORM

Xdebug 3 в консоли работает только с портом 9003. Поэтому в PhpStorm нужно поменять порядок портов с 9000,9003 на
9003,9000

# Интеграция

Интеграция возможна на платной и бесплатной основе.

В обоих случаях тест грузится через один виджет.

В обоих случаях загрузка виджета возможна только для зарегистрированного домена.

Отличие платного от бесплатного варианта только в наличии/отсутствии токена в урле.

### Бесплатная интеграция

```
<script src="https://testonomica/build/widget-v1.js"></script>
<div id="testonomica_app" data-test="TEST_KEY"></div>
```

### Платная интеграция

    <script src="https://testonomica/build/widget-v1.js"></script>
    <div id="testonomica_app" data-test="TEST_KEY" data-token="PUBLIC_TOKEN"></div>

TEST_KEY - сгенерированная единожды строка для таблицы test_api_hash{id, key, test_id}, эта строка служит
идентификатором теста на случай, если id или alias поменяется (новая версия теста). эта таблица позволит разом заменить
id теста не прибегая к просьбам поменять клиентов id.

PUBLIC_TOKEN - публичный ключ, полученный в запросе бекенд-бекенд. Наша сторона ожидает постоянный секретный
идентификатор партнёра и id их пользователя:

    https://testonomica.com/partner/api/token/?token=JFeBtqLY3Tgw3uGG6b29hpdvfLlglGBE&user={ID_ПОЛЬЗОВАТЕЛЯ_ТЕСТОМЕТРИКИ}&service=proftest

Ответом будет публичный токен:

    {"token":"cf738dd7-a138-4fa6-b3fd-52eef8ae2a92"}

Планирую сделать приём платежей прямо в виджете, если такое возможно в принципе - во всплывающем окне. Например, указать
дополнительно в платном варианте data-payment="auto". В случае с тестометрикой виджета нет, а сразу используется
js-приложение, поэтому приём платежей нужно сделать именно через это приложение, а не через виджет.

### Как устроена нутрянка

- Сервер партнера запрашивает публичный токен для юзера.

  В случае со скилбоксом действует предоплата (или постоплата).

  Для этого нужен доппараметр: payment (user|company).

  Если user - то всё как обычно - платит пользователь (а-ля тестометрика).

  Если company, то смотрим профиль компании:
  предоплата или постоплата. Если предоплата, то должен быть лимит, допустим 1000 штук. При наступленнии лимита вежливо
  уведомляем. Если постоплата, то лимита нет, но всегда должен быть подсчёт.

  ХЗ где и как пока. В обоих случаях (
  prepayment и postpaid) нужно вести учёт сколько израсходованно. Где? Мы ведём статистику - сколько раз партнёр
  предоставил доступ - сколько учтено, а сколько нет. Каждый запрос токена с уникальным юзером - это факт преобретения
  теста, то есть покупки.

- Виджет загружает страницу, где расположен автозагрузчик теста на react (далее App-js)
- App-js запрашивает данные по тесту у сервера, передавая полученный публичный токен доступа (далее AccessToken)
- Сервер утилизирует AccessToken, создаёт новый и возвращает
- App-js использует новый токен. Такой обмен одноразовыми токенами происходит каждый запрос. Для скорости можно
  использовать Redis.

#### Этот текст я писал для тестометрики:

Принцип остался прежний -

1. получить публичный токен для пользователя
2. сгенерировать ссылку для пользователя Поменялись урлы и параметры.

Теперь подробно:

1. Сначала делается скрытый запрос (backend, curl) и получается публичный токен:
   https://testonomica.com/partner/api/token/?token=JFeBtqLY3Tgw3uGG6b29hpdvfLlglGBE&user={ID_ПОЛЬЗОВАТЕЛЯ_ТЕСТОМЕТРИКИ}&service=proftest
   где {ID_ПОЛЬЗОВАТЕЛЯ_ТЕСТОМЕТРИКИ} - уникальный идентификатор пользователя в вашей системе. Дополнительно: чтобы
   протестировать интеграцию без оплаты нужно добавить в параметр &isTest=1, и тогда робокасса будет запущена в тестовом
   режиме, средства не списываются.

Ответом будет публичный токен в формате JSON:
{"token":"cf738dd7-a138-4fa6-b3fd-52eef8ae2a92"}

2. Нужно распарсить JSON и сгенерировать URL для пользователя:
   https://testonomica.com/partner/provide/?token={ПОЛУЧЕННЫЙ_ТОКЕН}
   Дальше этот URL навесить на кнопку "Пройти тест".