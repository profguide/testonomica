V3 писалась для интеграции с сайтом ставропольского колледжа и является более удобной версией V2 для провайдеров.

Вот что изменилось по сравнению с V1

- введены политики (политика регистрации пользователей и политика сохранения результатов).
- происходит начисление доступов; возможен лимит доступов (политика предоплаты).
- происходит учёт результатов пользователя ManyToMany (здесь могут быть введены ограничения в соостветствии с
  политикой работы с провайдером).

Вот что изменилось по сравнению с V2

- отсутствие явной регистрации пользователя, все действия провайдер совершает с пользовательским ID своей системы.
  Регистрация происходит между делом, что сильно облегчает взаимодействие провайдера с API (меньше запросов, не нужно
  хранить USER_KEY).

## Как работает Студика:

Студика продаёт результаты без регистрации, используя sess_id или cookie.
Пользователь проходит тест в виджете, виджет сохраняет результат, передаёт его студике.

- Прикрепить результат по sess_id
- Запросить результат

## Как работает ПрофГид платный:

Талантум и другие платные тесты работают как в студике. Триал-тест тоже. За исключением того, что на 70 вопросе виджет
просит вернуть список ответов для сохранения. После оплаты список ответов передаётся в виджет и пользователь продолжает
с 71 вопроса.

- Прикрепить результат по userId
- Запросить результат

## Как работает ПрофГид бесплатный:

Кастом-виджет. Результаты нигде не сохраняются. На руках прогресс.

- Запросить калькуляцию по прогрессу (существует старый API, ну пусть и существует пока.)

---

# API Documentation

Картина в целом:

1. **Регистрация провайдера**
   Клиентский сайт (провайдер) регистрируется на Тестодроме и получает постоянный
   секретный ключ "CLIENT_KEY".
   Провайдер принимает политику оплаты: "Политика предоплаты" или "Политика постоплаты".
   Если принята "Политика предоплаты", то для провайдера устанавливается лимит выдаваемых доступов для пользователей.
   "Политика постоплаты" предполагает выставление счёта на основе увеличения значения счётчика.

2. **Привязка результата к пользователю**
   Когда вопросник пройден, frontend (виджет) сам сохраняет результат как гостевой на Тестодроме и возвращает
   RESULT_KEY. Провайдер передаёт RESULT_KEY и userId (идентификатором пользователя, может выступить любая строка,
   например id, email, sess_id, ip и т.д.) в специальный метод для их связки. Невозможно получить доступ к
   результату, не связанного с пользователем.
   Если пользователь новый, то система регистрирует пользователя и происходит увеличение числа выданных провайдеру
   доступов на единицу. Перед регистрацией пользователя происходит проверка на достижение лимита выданных доступов, если
   компания приняла политику предоплаты. При политике постоплаты лимит выданных доступов значения не имеет. Счётчик
   выданных доступов будет служить предметом выставления счёта для оплаты провайдером.
   Перед связывание результата происходит ешё одна валидация по другой политике - "Политика Тестов". То есть проверяем
   прогресс каких тестов этот пользователь уже сохранил.
   "Политика тестов" для различных провайдеров может быть разная. Например, одному провайдера мы можем предоставлять по
   одному доступу только один тест, другому предоставить тест + бонус. Третьему сайту разрешено сохранять более одного
   результата одного теста для одного пользователя.

3. **Запрос результата по RESULT_KEY**
   Провайдер запрашивает результаты теста, используя RESULT_KEY любое число раз.

Эта схема взаимодейтсвия также позволяет получать список пользователей которые прошли или не прошли тест, какие тесты
прошёл конкретный пользователь, а так же статистику и лимиты доступов и даже счёт на оплату.

## Регистрация провайдера

Регистрация провайдера происходит по заявкам вручную. Напишите нам на почту: info@profguide.ru.

## Привязка пользователя к результату

Связывает результат с пользователем и возвращает статус операции.

**URL**: `GET /partner/api/v2/result/attach`

### Параметры:

- `client_key` (обязательный): Секретный постоянный ключ вашего сайта, который вы получили при регистрации вашего
  сайта.
  Этот параметр должен быть строкой.
- `user_id` (обязательный): уникальный идентификатор пользователя системы провайдера, например id, email, sess_id. Этот
  параметр должен быть строкой.
- `result_key` (обязательный): идентификатор результата. Этот параметр должен быть строкой.

### Результат:

- **Код состояния:** 200 ОК

### Возможные ошибки:

- Не указаны обязательные параметры.
- Не найден пользователь.
- Не найден результат.
- Достигнут предел выданных доступов (см. Политика доступов).
- Достигнут предел сохранённых результатов на одного пользователя (см. Политика тестов).

**Пример ошибки:**

```json
{
  "error": {
    "code": 404,
    "message": "User not found with the provided key."
  }
}
```