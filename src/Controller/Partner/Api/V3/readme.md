# V3

V3 была разработана для интеграции с сайтом Ставропольского колледжа и представляет собой слегка улучшенную версию V2,
ориентированную на удобство использования клиентом. В V3 добавлены возможности, которые позволят получать данные о
пользователях, которые прошли или не прошли тесты, а также информацию о том, какие тесты прошёл конкретный пользователь.
Кроме того, V3 сможет предоставить статистику использования лицензий, контроль лимитов лицензий и возможность получения
счёта на оплату.

Ключевые изменения:

- Упрощён процесс взаимодействия с API: клиент использует пользовательский ID из своей системы, и регистрация
  пользователей происходит автоматически, что уменьшает количество запросов и исключает необходимость хранения клиентом
  USER_KEY, использовавшийся в версиях v1, v2.
- Введены платёжная политика, определяющая модель работы клиента с платформой: предоплата или постоплата.
- Введена лицензионная политика, регулирующая количество результатов тестов, которые могут быть ассоциированы с одним
  пользователем.

---

# Словарь терминов

## Платформа

Платформа — это Тестодром и его API, предоставляющие доступ клиенту к тестированию и просмотру результатов.

## Клиент

Клиент — это зарегистрированный на платформе сайт или приложение, которое взаимодействует с платформой от имени своих
пользователей.

## Пользователь

Пользователь — это лицо в системе клиента, обладающее уникальным идентификатором. Для платформы один зарегистрированный
пользователь соответствует одной выданной лицензии. Платформа предоставляет результаты тестов только если они
ассоциированы с пользователем. Поэтому платформе необходимо знать ID пользователя. В качестве ID пользователя могут
использоваться также email, ID сессии, IP-адрес и т.д.

## Лицензия

Лицензия — это разрешение, предоставляющее пользователю право быть ассоциированным с результатами
теста. Количество результатов пользователя в рамках одной лицензии регулирует политика лицензий.

## Платёжная политика

1. *Политика предоплаты* — это модель взаимодействия клиента с платформой, при которой установлен лимит на количество
   выдаваемых лицензий. Увеличение лимита становится возможным после внесения оплаты.
2. *Политика постоплаты* — это модель взаимодействия клиента с платформой, при которой отсутствует предварительный лимит
   на лицензий. Оплата за выданные доступы производится по факту, на основании количества выданных лицензий.

## Политика лицензий

*Политика лицензий* регулирует количество результатов, которые могут быть ассоциированы с пользователем в рамках
одной лицензии.


---

# Принцип работы

## Регистрация клиента

Клиент регистрируется на платформе и получает постоянный ключ доступа — CLIENT_KEY. При регистрации клиент
принимает [платёжную политику](#платёжная-политика), а также [политику лицензий](#политика-лицензий). Регистрация
клиента происходит по заявкам вручную. Напишите нам на почту: info@profguide.ru.

## Прохождение теста

Клиент [запрашивает](#описание-теста) у платформы описание теста и [вопросы](#вопросы-к-тесту) к
нему. Эти данные доступны без специального разрешения. В процессе прохождения теста клиент накапливает ответы
пользователя. По достижению конца теста клиент [отправляет ответы](#сохранение-ответов-и-получение-resultkey-1)
пользователя на
платформу в специальном формате с целью их сохранения.

## Сохранение ответов и получение RESULT_KEY

Клиент [сохраняет ответы](#сохранение-ответов-и-получение-resultkey-1) пользователя на платформе и получает RESULT_KEY.
Однако
результат всё ещё не ассоциирован с пользователем, поэтому его нельзя получить. Для ассоциации результата с
пользователем необходимо выполнить [следующий шаг](#ассоциация-результата-с-пользователем).

## Ассоциация результата с пользователем

Клиент [отправляет специальный запрос](#ассоциация-результата-с-пользователем-1) на ассоциацию результата с
пользователем, включая RESULT_KEY и [идентификатор пользователя](#пользователь).
Платформа регистрирует пользователя, предварительно проверяя условия [платёжной политики](#платёжная-политика) (
например, достаточно ли лицензий доступно для использования). Для ассоциации результата
проверяется [политика лицензий](#политика-лицензий) (например, не превышает ли пользователь лимит по результатам). Если
условия не выполняются, платформа может отклонить регистрацию или ассоциацию.

## Получение результата

Клиент может [запрашивать результаты](#получение-результата-1) теста любое количество раз, используя RESULT_KEY.


---

# API

## Описание теста

Описание теста не ограничено правами.

**URL**: `GET /tests/api/v1/info/{{TEST}}/`

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "name": "Тест на профориентацию",
  "description": "<div>Описание теста<\/div>",
  "instruction": null,
  "authors": [
    {
      "name": "ПрофГид"
    }
  ],
  "duration": 20,
  "length": 125,
  "paid": true
}
```

## Вопросы к тесту

**URL первый вопрос** `GET /tests/api/v1/first/{{TEST}}/`
**URL следующий вопрос** `GET /tests/api/v1/next/{{TEST}}/`
**URL предыдущий вопрос** `GET /tests/api/v1/prev/{{TEST}}/`

### Результат

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "question": {
    "id": 1,
    "type": "option",
    "name": "Какая профессия Вам больше нравится?",
    "text": null,
    "img": null,
    "count": null,
    "gradient": 0,
    "timer": 0,
    "wrong": null,
    "correct": null,
    "enabledBack": true,
    "enabledForward": false,
    "showAnswer": false,
    "items": [
      {
        "id": null,
        "value": "q",
        "text": "Инженер",
        "img": ""
      },
      {
        "id": null,
        "value": "w",
        "text": "Социолог",
        "img": ""
      }
    ]
  },
  "number": 1,
  "length": 42
}
```

## Сохранение ответов и получение RESULT_KEY

Сохраняет ответы пользователя (прогресс - синоним) и возвращает идентификатор результата.

**URL**: `POST /partner/api/v3/progress/save`

### Параметры:

- `test` (обязательный): идентификатор теста. Этот параметр должен быть строкой.
- `progress` (JSON, обязательный): ответы на вопросы. Пример: ```[["1", ["a"]], ["2", ["b", "c"]]]```. Структура JSON
  представляет собой массив, где id вопроса это ключ, а ответы это значения. Некоторые вопросы поддерживают несколько
  ответов, поэтому ответы на вопрос являются массивом.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "result_key": "92f50432-dd78-4f57-b407-6bb273c78f62"
}
```

## Ассоциация результата с пользователем

Устанавливает связь пользователя с результатом и возвращает статус операции.

**URL**: `POST /partner/api/v3/result/attach`

### Параметры:

- `client_key` (обязательный): Секретный постоянный ключ вашего сайта, который вы получили при регистрации вашего
  сайта или приложения.
  Этот параметр должен быть строкой.
- `user_id` (обязательный): уникальный идентификатор пользователя системы клиента, например id, email, sess_id. Этот
  параметр должен быть строкой.
- `result_key` (обязательный): идентификатор результата. Этот параметр должен быть строкой.

### Результат:

- **Код состояния:** 200 ОК

### Возможные ошибки:

- Не указаны обязательные параметры.
- Не найден пользователь.
- Не найден результат.
- Достигнут предел выданных доступов (см. Политика доступов).
- Достигнут предел сохранённых результатов на одного пользователя (см. Политика тестов).

**Пример ошибки:**

```json
{
  "error": {
    "code": 404,
    "message": "User not found with the provided key."
  }
}
```

## Получение результата

**URL** `GET /partner/api/v3/result/get`

### Параметры:

- `result_key` (RESULT_KEY, обязательный): идентификатор результата. Этот параметр должен быть строкой.
- `format` (обязательный): возможные значения: json, html, pdf.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "VALUES": {
    "it": {
      "sum": 2,
      "percentage": 20,
      "percentage_value": 20
    },
    "design": {
      "sum": 8,
      "percentage": 80,
      "percentage_value": 80
    }
  }
}
```
