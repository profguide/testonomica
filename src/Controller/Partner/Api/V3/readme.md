# V3, введение

V3 была разработана для большего удобства клиента. В V3 добавлены возможности, которые позволят получать данные о
пользователях, которые прошли или не прошли тесты, а также информацию о том, какие тесты прошёл конкретный пользователь.
Кроме того, V3 сможет предоставить статистику использования лицензий, контроль лимитов лицензий и возможность получения
счёта на оплату.

Ключевые изменения:

- Упрощён процесс взаимодействия с API: клиент использует пользовательский ID из своей системы, и регистрация
  пользователей происходит автоматически, что уменьшает количество запросов и исключает необходимость хранения клиентом
  USER_KEY, использовавшийся в версиях v1, v2.
- Введены платёжная политика, определяющая модель работы клиента с платформой: предоплата или постоплата.
- Введена лицензионная политика, регулирующая количество результатов тестов, которые могут быть ассоциированы с одним
  пользователем.

---

# Словарь терминов

## Платформа

Платформа — это Тестодром и его API, предоставляющие доступ клиенту к тестированию и просмотру результатов.

## Клиент

Клиент — это зарегистрированный на платформе сайт или приложение, которое взаимодействует с платформой от имени своих
пользователей.

## Пользователь

Пользователь — это лицо в системе клиента, обладающее уникальным идентификатором. Для платформы один зарегистрированный
пользователь соответствует одной выданной лицензии. Платформа предоставляет результаты тестов только если они
ассоциированы с пользователем. Поэтому платформе необходимо знать ID пользователя. В качестве ID пользователя могут
использоваться также email, ID сессии, IP-адрес и т.д.

## Лицензия

Лицензия — это разрешение, предоставляющее пользователю право быть ассоциированным с результатами
теста. Количество результатов пользователя в рамках одной лицензии регулирует политика лицензий.

## Платёжная политика

1. *Политика предоплаты* — это модель взаимодействия клиента с платформой, при которой установлен лимит на количество
   выдаваемых лицензий. Увеличение лимита становится возможным после внесения оплаты.
2. *Политика постоплаты* — это модель взаимодействия клиента с платформой, при которой отсутствует предварительный лимит
   на лицензий. Оплата за выданные доступы производится по факту, на основании количества выданных лицензий.

## Лицензионная политика

*Лицензионная политика* регулирует количество результатов, которые могут быть ассоциированы с пользователем в рамках
одной лицензии.


---

# Краткий принцип работы

Клиент отправляет результаты теста и получает уникальный result_key. Затем клмент отправляет запрос с
result_key, user_id и client_key, чтобы ассоциировать результат с пользователем. Это считается выдачей лицензии клиенту.
Лицензии фиксируются для учёта постоплаты, и результат теста становится доступен пользователю после ассоциации.

# Детальный принцип работы

## Регистрация клиента

Клиент регистрируется на платформе и получает постоянный ключ доступа — CLIENT_KEY. При регистрации клиент
принимает [платёжную политику](#платёжная-политика), а также [лицензионную политику](#лицензионная-политика).
Регистрация клиента происходит по заявкам вручную. Напишите нам на почту: info@profguide.ru.

## Прохождение теста

Клиент [запрашивает](#описание-теста) у платформы описание теста и [вопросы](#вопросы-к-тесту) к
нему. Эти данные доступны без специального разрешения. В процессе прохождения теста клиент накапливает ответы
пользователя. По достижению конца теста клиент [отправляет ответы](#сохранение-ответов-и-получение-resultkey-1)
пользователя на
платформу в специальном формате с целью их сохранения.

## Сохранение ответов и получение RESULT_KEY

Клиент [сохраняет ответы](#сохранение-ответов-и-получение-resultkey-1) пользователя на платформе и получает RESULT_KEY.
Однако результат всё ещё не ассоциирован с пользователем, поэтому его нельзя получить. Для ассоциации результата с
пользователем необходимо выполнить [следующий шаг](#ассоциация-результата-с-пользователем).

## Ассоциация результата с пользователем

Клиент [отправляет специальный запрос](#ассоциация-результата-с-пользователем-1) на ассоциацию результата с
пользователем, включая RESULT_KEY и [идентификатор пользователя](#пользователь).
Платформа регистрирует пользователя, предварительно проверяя условия [платёжной политики](#платёжная-политика) (
например, достаточно ли лицензий доступно для использования). Для ассоциации результата
проверяется [Лицензионная политика](#лицензионная-политика) (например, не превышает ли пользователь лимит по
результатам). Если
условия не выполняются, платформа может отклонить регистрацию или ассоциацию.

## Получение результата

Клиент может [запрашивать результаты](#получение-результата-1) теста любое количество раз, используя RESULT_KEY.


---

# Методы API

## Получение описания теста и вопросов к нему

Описание теста не ограничено правами.

**URL**: `GET /tests/api/v1/info/{test}/`

### Параметры:

- `questions` (необязательный): `true`|`false`. Значение по умолчанию `false`. Добавляет к данным все вопросы из теста.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "name": "Тест на профориентацию",
  "description": "<div>Описание теста<\/div>",
  "instruction": null,
  "authors": [
    {
      "name": "ПрофГид"
    }
  ],
  "duration": 20,
  "length": 125,
  "paid": true,
  "questions": {
    "910": {
      "id": 910,
      "type": "option",
      "name": "Нравится ли вам анализировать язык тела и интонации собеседника во время общения?",
      "text": null,
      "img": null,
      "count": null,
      "gradient": 0,
      "timer": 0,
      "wrong": null,
      "correct": null,
      "enabledBack": true,
      "enabledForward": false,
      "showAnswer": false,
      "items": [
        {
          "id": null,
          "value": "1",
          "text": "Да",
          "img": ""
        },
        {
          "id": null,
          "value": "0",
          "text": "Нет",
          "img": ""
        }
      ]
    }
  }
}
```

## Получение вопросов по одному: первый, следующй, предыдущий

**URL первый вопрос** `GET /tests/api/v1/first/{test}/`
**URL следующий вопрос** `GET /tests/api/v1/next/{test}/`
**URL предыдущий вопрос** `GET /tests/api/v1/prev/{test}/`

### Результат

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "question": {
    "id": 1,
    "type": "option",
    "name": "Какая профессия Вам больше нравится?",
    "text": null,
    "img": null,
    "count": null,
    "gradient": 0,
    "timer": 0,
    "wrong": null,
    "correct": null,
    "enabledBack": true,
    "enabledForward": false,
    "showAnswer": false,
    "items": [
      {
        "id": null,
        "value": "q",
        "text": "Инженер",
        "img": ""
      },
      {
        "id": null,
        "value": "w",
        "text": "Социолог",
        "img": ""
      }
    ]
  },
  "number": 1,
  "length": 42
}
```

## Сохранение ответов и получение RESULT_KEY

Сохраняет ответы пользователя (прогресс - синоним) и возвращает идентификатор результата.

**URL**: `POST /partner/api/v3/progress/save`

### Параметры:

- `test` (обязательный): идентификатор теста. Этот параметр должен быть строкой.
- `progress` (JSON, обязательный): ответы на вопросы. Пример: ```[["1", ["a"]], ["2", ["b", "c"]], ["3", []]]]```.
  См. [подробнее о формате параметра](#формат-параметра-progress).

#### Формат параметра "progress"

Структура параметра `progress` представляет собой JSON-массив, где каждый элемент — это массив, содержащий ID вопроса и
массив ответов. Каждый элемент первого уровня представляет собой массив, в котором:
Первый элемент — ID вопроса (строка).
Второй элемент — массив ответов (строка), который может содержать несколько значений, так как некоторые вопросы могут
иметь несколько допустимых вариантов ответа. Если вопрос пропущен, он должен быть представлен в списке с пустым массивом
значений.

##### Пример с одним ответом на вопрос

```[["1", ["a"]], ...]```

В этом примере мы видим, что вопрос id#1 имеет ответ "a".

##### Пример с несколькими ответами на вопрос

```[["2", ["b", "c"]], ...]```

В этом примере мы видим, что вопрос id#2 имеет ответы "b" и "c".

##### Пример с пропущенным ответом на вопрос

```[["3", []], ...]```

В этом примере мы видим, что вопрос id#3 не имеет ответов.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "result_key": "92f50432-dd78-4f57-b407-6bb273c78f62"
}
```

## Ассоциация результата с пользователем

Устанавливает связь пользователя с результатом и возвращает статус операции.

**URL**: `POST /partner/api/v3/result/attach`

### Параметры:

- `client_key` (обязательный): Секретный постоянный ключ вашего сайта, который вы получили при регистрации вашего
  сайта или приложения.
  Этот параметр должен быть строкой.
- `user_id` (обязательный): уникальный идентификатор пользователя системы клиента, например id, email, sess_id. Этот
  параметр должен быть строкой.
- `result_key` (обязательный): идентификатор результата. Этот параметр должен быть строкой.

### Результат:

- **Код состояния:** 200 ОК

### Возможные ошибки:

- Не указаны обязательные параметры.
- Не найден пользователь.
- Не найден результат.
- Достигнут предел выданных доступов [(см. платёжная политика)](#платёжная-политика).
- Достигнут предел сохранённых результатов на одного пользователя [(см. лицензионная политика)](#лицензионная-политика).

**Пример ошибки:**

```json
{
  "error": {
    "code": 404,
    "message": "User not found with the provided key."
  }
}
```

## Получение результата

**URL** `GET /partner/api/v3/result/get`

### Параметры:

- `result_key` (RESULT_KEY, обязательный): идентификатор результата. Этот параметр должен быть строкой.
- `format` (обязательный): возможные значения: json, html, pdf.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "VALUES": {
    "it": {
      "sum": 2,
      "percentage": 20,
      "percentage_value": 20
    },
    "design": {
      "sum": 8,
      "percentage": 80,
      "percentage_value": 80
    }
  }
}
```