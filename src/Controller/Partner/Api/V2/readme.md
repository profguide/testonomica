V2 писалась для интеграции с сайтом ставропольского колледжа.

Вот что изменилось по сравнению с предыдущими версиями.

- вводится регистрация пользователя (нужен id - это может быть email, sess_id и тд), взамен мы даём постоянный
  USER_TOKEN.
- введены политики (политика регистрации пользователей и политика сохранения результатов).
- происходит начисление доступов; возможен лимит доступов (политика предоплаты).
- происходит учёт результатов пользователя ManyToMany (здесь могут быть введены ограничения в соостветствии с
  политикой работы с клиентским сайтом)

---

# API Documentation

Картина в целом:

1. **Регистрация провайдера**
   Клиентский сайт (провайдер) регистрируется на Тестодроме и получает постоянный
   секретный токен "CLIENT_KEY".
   Провайдер принимает политику оплаты: "Политика предоплаты" или "Политика постоплаты".
   Если принята "Политика предоплаты", то для провайдера устанавливается лимит выдаваемых доступов для пользователей.
   "Политика постоплаты" предполагает выставление счёта на основе увеличения значения счётчика.

2. **Регистрация пользователя и инкремент счётчика выданных доступов**
   Провайдер регистрирует своего пользователя на Тестодроме по API и получает постоянный USER_KEY пользователя.
   Идентификатором пользователя может выступить любая строка, например id, email, sess_id, ip и т.д.
   При этом происходит увеличение числа выданных провайдеру доступов на единицу.
   Повторный запрос возвращает USER_KEY найденного пользователя, а счётчик доступов не увеличивается.
   Перед регистрацией пользователя происходит проверка на достижение лимита выданных доступов,
   если компания приняла политику предоплаты.
   При политике постоплаты лимит выданных доступов значения не имеет. Счётчик выданных доступов будет служить предметом
   выставления счёта для оплаты провайдером.

3. **Запрос токена прохождения теста (что-то типа сессии) (не используется)**
   Перед показом теста клиентский сайт запрашивает одноразовый токен ACCESS_TOKEN (как сейчас, это нужно расписать
   подробнее).
   TODO: заменить varchar на uuid с типом BINARY(16), чтобы сильно ускорить работу. varchar с индексом работает
   медленно.
   PS. А зачем этот токен выдавать? Разве не достаточно использовать USER_KEY для сохранения результата?
   По-моему я это место просто не додумал. Вроде бы у меня тогда была идея выдавать пользователю токен прохождения
   теста, который был бы активен для текущей сессии теста - только вообще не понимаю зачем. Наверно, чтобы вести учёт
   прохождений теста.

4. **Сохранение прогресса или привязка результата к пользователю - на выбор провайдера**
   А) **Сохраняется прогресс и выдаётся ID результата**
   Когда вопросник пройден, провайдер сохраняет прогресс (ответы), используя USER_KEY и получает RESULT_KEY.
   Здесь мы сверяемся с другой политикой - "Политикой Тестов". То есть проверям прогресс каких тестов этот пользователь
   уже сохранил.
   "Политика тестов" для различных провайдеров может быть разная. Например, одному провайдера мы можем предоставлять по
   одному доступу только один тест, другому предоставить тест + бонус. Третьему сайту разрешено сохранять более одного
   результата одного теста для одного пользователя.

   Б) **Результат прикрепляется к пользователю**
   TODO
   Когда вопросник пройден, и прогресс был сохранён автоматически без привязки к пользователю. При этом проверяем
   конечно всё как в варианте А.

5. **Запрашивается результат по ID результата**
   Провайдер запрашивает результаты теста, используя RESULT_KEY любое число раз.

Эта схема взаимодейтсвия также позволяет получать список пользователей которые прошли или не прошли тест, какие тесты
прошёл конкретный пользователь, а так же статистику и лимиты доступов и даже счёт на оплату.

## Регистрация провайдера

Регистрация провайдера происходит по заявкам вручную. Напишите нам на почту: info@profguide.ru.

## Регистрация пользователя

Регистрирует пользователя на Тестодроме и увеличивает счётчик выданных доступов на один. Повторно пользователь не
создаётся и счётик не увеличивается.

**URL**: `GET /partner/api/v2/user/register`

### Параметры:

- `client` (обязательный): Секретный постоянный токен вашего сайта, который вы получили при регистрации вашего сайта.
  Этот параметр должен быть строкой.
- `user_id` (обязательный): уникальный идентификатор пользователя в вашей системе, например, id, email или sess_id.
  Этот параметр должен быть строкой.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "user_key": "92f50432-dd78-4f57-b407-6bb273c78f62"
}
```

### Возможные ошибки:

- Не указаны обязательные параметры.
- Клиент не найден по указанному токену.
- Достигнут предел выданных доступов (см. Политика оплаты).

**Пример ошибки:**

```json
{
  "error": {
    "code": 404,
    "message": "Client not found with the provided token."
  }
}
```

## Сохранение прогресса (ответов)

Сохраняет прогресс (ответы) пользователя и возвращает ID результата.

**URL**: `GET /partner/api/v2/progress/save`

### Параметры:

- `test` (обязательный): идентификатор теста. Этот параметр должен быть строкой.
- `user_key` (обязательный): ключ пользователя, который был получен во время процедуры регистрации. (см. Регистрация
  пользователя).
- `progress` (обязательный): прогресс (ответы на вопросы).

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "result_key": "92f50432-dd78-4f57-b407-6bb273c78f62"
}
```

### Возможные ошибки:

- Не указаны обязательные параметры.
- Не найден пользователь.
- Не найден тест.
- Достигнут предел сохранённых результатов на одного пользователя (см. Политика тестов).

**Пример ошибки:**

```json
{
  "error": {
    "code": 404,
    "message": "User not found with the provided key.."
  }
}
```