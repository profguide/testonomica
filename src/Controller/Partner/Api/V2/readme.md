V2 писалась для интеграции с сайтом ставропольского колледжа.

Вот что изменилось по сравнению с предыдущими версиями.

- вводится регистрация пользователя (нужен id), взамен мы даём постоянный USER_TOKEN.
- введены политики (политика регистрации пользователей и политика сохранения результатов).
- происходит списание доступов (можно в минус, если политика работы с клиентским сайтом позволяет это)
- происходит учёт результатов пользователя ManyToMany (здесь могут быть введены ограничения в соостветствии с
  политикой работы с клиентским сайтом)

---

# API Documentation

Карина в целом:

1. **Регистрация провайдера**
   Клиентский сайт (провайдер) регистрируется на Тестодроме и получает постоянный
   секретный токен "CLIENT_KEY".
   Провайдер принимает политику оплаты: "Политика предоплаты" или "Политика постоплаты".
   Если принята "Политика предоплаты", то для провайдера устанавливается лимит выдаваемых доступов для пользователей.

2. **Регистрация пользователя и инкремент счётчика выданных доступов**
   Провайдер регистрирует своего пользователя на Тестодроме по API и получает постоянный USER_KEY пользователя.
   При этом происходит увеличение числа выданных провайдеру доступов на единицу.
   Повторный запрос возвращает USER_KEY найденного пользователя, а счётчик доступов не увеличивается.
   Перед регистрацией пользователя происходит проверка на достижение лимита выданных доступов,
   если компания приняла политику предоплаты.
   При политике постоплаты лимит выданных доступов значения не имеет. Счётчик выданных доступов будет служить предметом
   выставления счёта для оплаты провайдером.

3. **Запрашивается токен прохождения теста**
   Перед показом теста клиентский сайт запрашивает одноразовый токен ACCESS_TOKEN (как сейчас, это нужно расписать
   подробнее).
   TODO: заменить varchar на uuid с типом BINARY(16), чтобы сильно ускорить работу. varchar с индексом работает
   медленно.
   TODO: удалять старые токены роботом. Допустим, срок жизни токена - 24 часа.

4. **Сохраняется прогресс и выдаётся ID результата**
   Когда вопросник пройден, провайдер сохраняет прогресс (ответы), используя USER_KEY и получает RESULT_KEY.
   Здесь мы сверяемся с другой политикой - "Политикой Тестов". То есть проверям прогресс каких тестов этот пользователь
   уже сохранил.
   "Политика тестов" для различных провайдеров может быть разная. Например, одному провайдера мы можем предоставлять по
   одному доступу только один тест, другому предоставить тест + бонус. Третьему сайту разрешено сохранять более одного
   результата одного теста для одного пользователя.

5. **Запрашивается результат по ID результата**
   Провайдер запрашивает результаты теста, используя RESULT_KEY любое число раз.

Эта схема взаимодейтсвия возмолит по api запрашивать тесты доступы пользователю USER_KEY, какие он уже прошёл,
а также сколько всего выпущено доступов, какой лимит установлен, и ещё получить список пользователей с их результатами.

## Регистрация пользователя

Регистрирует пользователя на Тестодроме и увеличивает счётчик выданных доступов на один. Повторно пользователь не
создаётся и счётик не увеличивается.

**URL**: `GET /partner/api/v2/user/register`

### Параметры:

- `client` (обязательный): Секретный постоянный токен вашего сайта, который вы получили при регистрации вашего сайта.
  Этот параметр должен быть строкой.
- `user_id` (обязательный): уникальный идентификатор пользователя в вашей системе, например, id или email. Этот параметр
  должен быть строкой.

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "user_key": "92f50432-dd78-4f57-b407-6bb273c78f62"
}
```

### Возможные ошибки:

- Не указаны обязательные параметры.
- Клиент не найден по указанному токену.
- Достигнут предел выданных доступов.

**Пример ошибки:**

```json
{
  "error": {
    "code": 404,
    "message": "Client not found with the provided token."
  }
}
```

## Сохранение прогресса (ответов)

Сохраняет прогресс (ответы) пользователя и возвращает ID результата.

**URL**: `GET /partner/api/v2/progress/save`

### Параметры:

- `test` (обязательный): идентификатор теста. Этот параметр должен быть строкой.
- `user_key` (обязательный): ключ пользователя, который был получен во время процедуры регистрации. (см. Регистрация
  пользователя).
- `progress` (обязательный): прогресс (ответы на вопросы).

### Результат:

- **Код состояния:** 200 ОК
- **Пример успешного ответа:**

```json
{
  "result_key": "92f50432-dd78-4f57-b407-6bb273c78f62"
}
```

### Возможные ошибки:

- Не указаны обязательные параметры.
- Не найден пользователь.
- Не найден тест.
- Достигнут предел сохранённых результатов на одного пользователя.

**Пример ошибки:**

```json
{
   "error": {
      "code": 404,
      "message": "User not found with the provided key.."
   }
}
```